# Worklog 2026-01-23

## 작업 개요
- **프로젝트**: `video-editor.py` 성능 개선 및 검증
- **작업 내용**: FFmpeg `concat` 필터를 `select` 필터로 변경하고, 대용량 영상으로 성능 검증
- **사용한 Skill**: `Video Edit Skill` (`04-Skill-C-Video-Edit`)
- **입력 파일**: `original.mkv` (92.2분, 363.7MB)
- **출력 파일**: `original_edited.mkv` (62.3분, 252.6MB)
- **작성자**: Claude

---

## 실험 결과

| 항목 | 원본 | 편집 후 | 변화 |
|------|------|---------|------|
| 길이 | 01:32:14 (92.2분) | 01:02:17 (62.3분) | -32.5% |
| 크기 | 363.7MB | 252.6MB | -30.5% |
| 무음 구간 | 1,730개 | - | 35.7분 제거 |
| 유지 구간 | 1,731개 | - | 62.3분 유지 |

- **실험 성공**: `select` 필터 방식으로 변경 후 약 3시간 만에 처리 완료.
- **성능 개선**: 이전 `concat` 필터 방식 대비 **3배 이상 빠른 처리 속도** 달성.

---

## 성능 비교 (concat vs select 필터)

| 항목 | concat 필터 (이전) | select 필터 (현재) | 개선율 |
|------|-------------------|-------------------|--------|
| 처리 시간 | ~70시간 예상 (중단) | ~3시간 | **95% 이상 단축** |
| 구간 수 | 1,731개 처리 불가 | 1,731개 정상 처리 | 안정성 확보 |
| 안정성 | WinError 206 발생 | 정상 완료 | 오류 해결 |

---

## 발생한 이슈 및 해결

### Issue 1: concat 필터의 성능 저하 문제

**증상**:
- 이전 테스트에서 1,731개 구간 처리 시 70시간 이상 소요 예상
- FFmpeg가 수천 개의 trim + concat 필터를 처리하는 데 기하급수적 시간 증가

**원인**:
- `concat` 필터는 각 구간을 별도의 스트림으로 생성 후 연결하는 방식
- 구간 수가 많을수록 메모리 사용량과 처리 시간이 급격히 증가

**해결**:
- `select` 필터 + `between(t,start,end)` 표현식으로 변경
- 청크 분할 처리 (100개 구간씩) + 최종 병합 방식 적용

```python
# 변경된 필터 방식
select_expr = "+".join([f"between(t,{start/1000},{end/1000})" for start, end in chunk_ranges])
filter_complex = f"[0:v]select='{select_expr}',setpts=N/FRAME_RATE/TB[v];[0:a]aselect='{select_expr}',asetpts=N/SR/TB[a]"
```

### Issue 2: 진행 상황 표시 부재

**증상**:
- 장시간 작업 중 진행 상황을 알 수 없어 사용자 경험 저하

**해결**:
- FFmpeg stderr에서 `time=00:00:00.00` 패턴을 실시간 파싱
- 각 묶음별 예상 시간 대비 진행률 백분율로 표시
- carriage return (`\r`)으로 같은 줄에 업데이트

```
      - 묶음 1/18: 100개 구간 (222.0초)
        진행: 00:03:42.08 / 222.0초 (100.0%)
        [OK] 묶음 1 완료
```

### Issue 3: 에러 메시지 가독성

**증상**:
- FFmpeg 실패 시 stderr 전체 출력으로 핵심 오류 파악 어려움

**해결**:
- `extract_ffmpeg_error()` 함수 추가
- `error`, `invalid`, `failed` 등 키워드 포함 줄만 추출
- 마지막 5개 에러 메시지만 표시

---

## 사용된 스크립트 및 Skill

| 파일 | 용도 | 변경 사항 |
|------|------|-----------|
| `video-editor.py` | 무음/필러 단어 제거 | concat → select 필터, 진행 상황 표시, 에러 추출 |
| `fast-silence-remover.py` | 참조 구현 | select 필터 패턴 참조 |

---

## 코드 변경 내역

### 1. `extract_ffmpeg_error()` 함수 추가 (247-259행)

```python
def extract_ffmpeg_error(stderr_text):
    """FFmpeg stderr에서 핵심 에러 메시지만 추출"""
    error_keywords = ['error', 'invalid', 'failed', 'cannot', 'no such', 'not found', 'unable']
    error_lines = []
    for line in stderr_text.split('\n'):
        line_lower = line.lower()
        if any(keyword in line_lower for keyword in error_keywords):
            error_lines.append(line.strip())
    if error_lines:
        return '\n'.join(error_lines[-5:])
    return stderr_text[-500:] if len(stderr_text) > 500 else stderr_text
```

### 2. `edit_video_ffmpeg()` 함수 개선 (262-397행)

- **select 필터 적용**: `between(t,start,end)` 표현식으로 구간 선택
- **청크 분할 처리**: 100개 구간씩 임시 파일로 생성 후 최종 병합
- **진행 상황 표시**: 실시간 stderr 파싱 및 백분율 표시
- **에러 처리 개선**: 핵심 에러만 추출하여 표시

---

## 학습 포인트

1. **FFmpeg 필터 성능 특성**:
   - `concat` 필터: 구간 수에 비례하여 기하급수적 성능 저하
   - `select` 필터: 구간 수와 무관하게 일정한 성능 유지
   - 대량 구간 처리 시 `select` + `setpts` 조합이 최적

2. **청크 분할 처리 전략**:
   - 100개 단위로 분할하여 메모리 사용량 제한
   - 각 청크를 별도 인코딩 후 `-c copy`로 빠른 병합
   - 임시 파일 자동 정리로 디스크 공간 관리

3. **사용자 경험 개선**:
   - 장시간 작업 시 진행 상황 표시 필수
   - 에러 발생 시 핵심 메시지만 추출하여 가독성 확보

---

## 사용자 인사이트

### 1. select 필터의 효율성

- `select` 필터는 입력 파일을 한 번만 읽으면서 필요한 구간만 선택
- `concat`은 각 구간마다 별도 스트림을 생성하므로 오버헤드 발생
- **결론**: 다수의 짧은 구간을 처리할 때는 반드시 `select` 필터 사용

### 2. 청크 분할의 필요성

- Windows 명령줄 길이 제한 (32KB) 우회
- 메모리 사용량 분산
- 부분 실패 시 해당 청크만 재처리 가능

### 3. 진행 상황 표시의 중요성

- 3시간 작업 중 진행률 확인 가능으로 안심하고 대기 가능
- 각 묶음 완료 시점을 알 수 있어 전체 예상 시간 추정 가능

---

## 다음 작업

- [x] `video-editor.py` 스크립트에 `select` 필터 방식 적용
- [x] 진행 상황 실시간 표시 기능 추가
- [x] 에러 메시지 추출 함수 추가
- [x] 대용량 영상(92분)으로 성능 검증 완료
- [ ] GPU 가속(NVENC) 옵션 추가 검토
- [ ] 필러 단어 제거 기능과 함께 통합 테스트
